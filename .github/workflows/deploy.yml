name: Deploy Frontend to Lightsail

on:
  push:
    branches:
      - master # ou main, dependendo do seu branch principal

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_FRONTEND_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Get latest backend image URI
        id: backend-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          LATEST_BACKEND_TAG=$(aws ecr describe-images --repository-name ${{ secrets.ECR_BACKEND_REPOSITORY }} --query 'sort_by(imageDetails, &imagePushedAt)[-1].imageTags[0]' --output text)
          # Se não encontrar tag, força 'latest'
          if [ "$LATEST_BACKEND_TAG" = "None" ] || [ -z "$LATEST_BACKEND_TAG" ]; then LATEST_BACKEND_TAG="latest"; fi
          echo "uri=$ECR_REGISTRY/${{ secrets.ECR_BACKEND_REPOSITORY }}:$LATEST_BACKEND_TAG" >> $GITHUB_OUTPUT

      - name: Prepare deployment file
        env:
          DB_URL: ${{ secrets.DATASOURCE_URL }}
          DB_USER: ${{ secrets.DATASOURCE_USERNAME }}
          DB_PASSWORD: ${{ secrets.DATASOURCE_PASSWORD }}
          FRONTEND_IMAGE: ${{ steps.build-image.outputs.image }}
          BACKEND_IMAGE: ${{ steps.backend-image.outputs.uri }}
        run: |
          python3 - << 'PY'
          import json, os

          with open('lightsail-deployment.json', 'r', encoding='utf-8') as f:
              data = json.load(f)

          # Replace image placeholders
          tpl_front = 'IMAGE_PLACEHOLDER_FRONTEND'
          tpl_back = 'IMAGE_PLACEHOLDER_BACKEND'

          # The following keys are the container names in the template
          # Keep in sync with lightsail-deployment.json
          containers = data.get('containers', {})
          for name, cfg in containers.items():
              img = cfg.get('image')
              if img == tpl_front:
                  cfg['image'] = os.environ['FRONTEND_IMAGE']
              elif img == tpl_back:
                  cfg['image'] = os.environ['BACKEND_IMAGE']

          # Replace DB env placeholders exactly if they exist
          backend = containers.get('property-valuation-backend')
          if backend is None:
              raise SystemExit('Template missing containers.property-valuation-backend')

          env = backend.setdefault('environment', {})
          if env.get('SPRING_DATASOURCE_URL') == 'DATASOURCE_URL':
              env['SPRING_DATASOURCE_URL'] = os.environ['DB_URL']
          if env.get('SPRING_DATASOURCE_USERNAME') == 'DATASOURCE_USERNAME':
              env['SPRING_DATASOURCE_USERNAME'] = os.environ['DB_USER']
          if env.get('SPRING_DATASOURCE_PASSWORD') == 'DATASOURCE_PASSWORD':
              env['SPRING_DATASOURCE_PASSWORD'] = os.environ['DB_PASSWORD']

          with open('final-deployment.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False)

          print('final-deployment.json written')
          PY

          echo "--- Final Deployment JSON (password hidden) ---"
          python3 - << 'PY'
          import json
          d=json.load(open('final-deployment.json','r',encoding='utf-8'))
          b=d['containers'].get('property-valuation-backend',{})
          if 'environment' in b and 'SPRING_DATASOURCE_PASSWORD' in b['environment']:
              b['environment']['SPRING_DATASOURCE_PASSWORD'] = '<password_hidden>'
          print(json.dumps(d, ensure_ascii=False, indent=2))
          PY

      - name: Deploy to Amazon Lightsail
        run: |
          aws lightsail create-container-service-deployment --cli-input-json file://final-deployment.json

